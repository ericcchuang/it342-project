name: Deploy Backend via Bastion

on:
  push:
    branches: ["main"]
    paths:
      - "api/**"
      - ".github/workflows/upload-api-aws.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Copy Source to Public EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "api/*"
          target: "/home/${{ secrets.EC2_USER }}/build-stage"
          rm: true

      - name: Install & Bundle on Public EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "${{ secrets.EC2_SSH_KEY }}" > deploy_key.pem
            chmod 600 deploy_key.pem

            cd ~/build-stage/api

            echo "Generating .env file..."
            echo "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}" > prod.env
            echo "NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}" >> prod.env
            echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" >> prod.env
            echo "PG_HOST=${{ secrets.PG_HOST }}" >> prod.env
            echo "PG_USER=${{ secrets.PG_USER }}" >> prod.env
            echo "PG_PASSWORD=${{ secrets.PG_PASSWORD }}" >> prod.env
            echo "PG_DATABASE=postgres" >> prod.env
            echo "PG_PORT=5432" >> prod.env

            echo "Installing dependencies..."
            npm ci --omit=dev

            echo "Zipping application..."
            cd ..
            tar -czf backend-deploy.tar.gz api

            echo "Copying to Private EC2..."
            scp -o StrictHostKeyChecking=no -i ~/deploy_key.pem backend-deploy.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_API_HOST }}:~/

            rm ~/deploy_key.pem

      - name: Deploy on Private EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_API_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_API_SSH_KEY }}
          proxy_host: ${{ secrets.EC2_HOST }}
          proxy_username: ${{ secrets.EC2_USER }}
          proxy_key: ${{ secrets.EC2_API_SSH_KEY }}
          script: |
            echo "Deploying on Private Server..."

            rm -rf ~/spiderweb-api
            mkdir -p ~/spiderweb-api

            tar -xzf ~/backend-deploy.tar.gz -C ~/spiderweb-api

            cd ~/spiderweb-api/api
            pm2 reload ecosystem.config.js --update-env --env production || pm2 start ecosystem.config.js --env production
            pm2 save

            echo "Deployment Complete!"
