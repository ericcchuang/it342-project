name: Deploy Backend

on:
  push:
    branches:
      - "main"
      - "refactoring"
    paths:
      - "api/**"
      - ".github/workflows/upload-api-aws.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Copy Source to Public EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "api/*"
          target: "/home/${{ secrets.EC2_USER }}/build-stage"
          rm: true

      - name: Install & Bundle on Public EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "${{ secrets.EC2_API_SSH_KEY }}" > deploy_key.pem
            chmod 600 deploy_key.pem

            cd ~/build-stage/api

            echo "Generating .env file..."
            echo "NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}" > prod.env
            echo "NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}" >> prod.env
            echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" >> prod.env
            echo "PG_HOST=${{ secrets.PG_HOST }}" >> prod.env
            echo "PG_USER=${{ secrets.PG_USER }}" >> prod.env
            echo "PG_PASSWORD=${{ secrets.PG_PASSWORD }}" >> prod.env
            echo "PG_DATABASE=postgres" >> prod.env
            echo "PG_PORT=5432" >> prod.env

            echo "Installing dependencies..."
            npm ci --omit=dev

            echo "Zipping application..."
            cd ..
            tar -czf backend-deploy.tar.gz api

            echo "Copying to Private EC2..."
            scp -o StrictHostKeyChecking=no -i ~/deploy_key.pem backend-deploy.tar.gz ${{ secrets.EC2_USER }}@${{ secrets.EC2_API_HOST }}:/home/${{ secrets.EC2_USER }}/backend-deploy.tar.gz

            rm ~/deploy_key.pem

      - name: Deploy on Private EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_API_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_API_SSH_KEY }}
          proxy_host: ${{ secrets.EC2_HOST }}
          proxy_username: ${{ secrets.EC2_USER }}
          proxy_key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "Deploying on Private Server..."

            PM2_CMD=/usr/local/bin/pm2 

            if [ -f "/home/${{ secrets.EC2_USER }}/backend-deploy.tar.gz" ]; then
              echo "File found. Extracting..."
              
              rm -rf ~/spiderweb-api
              mkdir -p ~/spiderweb-api
              
              # FIX 3: Unzip explicitly from the full path
              tar -xzf /home/${{ secrets.EC2_USER }}/backend-deploy.tar.gz -C ~/spiderweb-api
              
              cd ~/spiderweb-api/api
              
              echo "Starting PM2..."
              $PM2_CMD reload ecosystem.config.js --update-env --env production || $PM2_CMD start ecosystem.config.js --env production
              $PM2_CMD save
              
              echo "Cleaning up..."
              rm /home/${{ secrets.EC2_USER }}/backend-deploy.tar.gz
            else
              echo "ERROR: /home/${{ secrets.EC2_USER }}/backend-deploy.tar.gz NOT FOUND"
              ls -l /home/${{ secrets.EC2_USER }}/
              exit 1
            fi
