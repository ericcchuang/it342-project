name: Backend (Express API) Deployment

on:
    push:
        branches:
            - main
        paths:
            - "api/**"
            - ".github/workflows/upload-api-aws.yml"

jobs:
    deploy-backend:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: "api/package-lock.json"

            - name: Deploy Express API Code
              uses: easingthemes/ssh-deploy@v5.0.0
              with:
                  SSH_PRIVATE_KEY: ${{ secrets.EC2_API_SSH_KEY }}
                  REMOTE_HOST: ${{ secrets.EC2_API_HOST }}
                  REMOTE_USER: ${{ secrets.EC2_USER }}
                  SOURCE: "api/server.js api/api-ecosystem.config.js api/package.json api/package-lock.json"
                  TARGET: "/var/www/spiderweb"

            - name: Configure Environment and Reload API on EC2
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      cd /var/www/spiderweb

                      echo "Creating prod.env file with secrets..."
                      cat << EOF > prod.env
                      NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
                      NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
                      NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}

                      PG_HOST=${{ secrets.PG_HOST }}
                      PG_USER=${{ secrets.PG_USER }}
                      PG_PASSWORD=${{ secrets.PG_PASSWORD }}
                      PG_DATABASE=postgres
                      PG_PORT=5432
                      EOF
                      echo "prod.env created successfully."

                      npm ci --omit=dev

                      pm2 reload api-ecosystem.config.js || pm2 start api-ecosystem.config.js

                      pm2 reload ecosystem.config.js || pm2 start ecosystem.config.js

                      pm2 save
